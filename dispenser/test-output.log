yarn run v1.22.19
warning ../package.json: No license field
$ /Users/mbultra/projects/clawdnation/dispenser/node_modules/.bin/ts-mocha -p ./tsconfig.json -t 1000000 tests/dispenser.ts
(node:80194) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /Users/mbultra/projects/clawdnation/dispenser/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  dispenser — full security test suite
    1. initialization
      ✔ initializes with correct authority and pending_authority=None (477ms)
      ✔ GRIEF: re-initialization blocked (PDA exists)
    2. operator management
      ✔ authority adds operator (466ms)
      ✔ PRIV-ESC: non-operator cannot add themselves
      ✔ PRIV-ESC: non-operator cannot remove operator
      ✔ PRIV-ESC: cannot remove authority
      ✔ duplicate add is idempotent (448ms)
      1) FIX #3: max 10 operators enforced
    3. authority transfer (2-step)
      2) authority proposes transfer
      ✔ PRIV-ESC: non-authority cannot propose transfer
      3) PRIV-ESC: wrong person cannot accept transfer
      ✔ authority can cancel transfer (444ms)
      ✔ GRIEF: accept with no pending transfer fails
      4) full transfer cycle works
    4. add_recipient
      ✔ operator queues distribution (461ms)
      ✔ FIX #2: zero amount rejected
      ✔ GRIEF: duplicate contribution_id blocked (PDA exists)
      ✔ GRIEF: non-operator cannot queue
      ✔ FIX #4: overflow on total_queued rejected
      ✔ queue second distribution (455ms)
    5. distribute
      5) DRAIN: non-operator cannot distribute
      6) FIX #1: wrong recipient token account owner rejected
      7) DRAIN: wrong vault (different authority) rejected
      ✔ DRAIN: wrong mint rejected (1411ms)
      8) legitimate distribution succeeds
      9) DRAIN: double-distribute blocked
    6. cancel
      ✔ GRIEF: non-operator cannot cancel
      ✔ operator cancels queued distribution (469ms)
      ✔ GRIEF: cannot double-cancel
      10) GRIEF: cannot cancel already-distributed
      11) GRIEF: cannot distribute after cancel
    7. account safety
      ✔ state PDA owned by program
      ✔ distribution PDAs owned by program
      ✔ vault has correct authority (state PDA)
    8. state accounting
      12) total_distributed matches actual transfers
    total_queued: 10000000000000
    total_distributed: 0
    total_cancelled: 15000000000000
      ✔ total_queued tracks pending distributions
      ✔ FIX #4: checked arithmetic on cancel (total_queued subtraction)


  25 passing (16s)
  12 failing

  1) dispenser — full security test suite
       2. operator management
         FIX #3: max 10 operators enforced:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:169:28
      at Generator.next (<anonymous>)
      at fulfilled (tests/dispenser.ts:28:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  2) dispenser — full security test suite
       3. authority transfer (2-step)
         authority proposes transfer:
     Error: AnchorError caused by account: state. Error Code: AccountDidNotSerialize. Error Number: 3004. Error Message: Failed to serialize the account.
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  3) dispenser — full security test suite
       3. authority transfer (2-step)
         PRIV-ESC: wrong person cannot accept transfer:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:208:28
      at Generator.throw (<anonymous>)
      at rejected (tests/dispenser.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  4) dispenser — full security test suite
       3. authority transfer (2-step)
         full transfer cycle works:
     Error: AnchorError caused by account: state. Error Code: AccountDidNotSerialize. Error Number: 3004. Error Message: Failed to serialize the account.
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  5) dispenser — full security test suite
       5. distribute
         DRAIN: non-operator cannot distribute:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:388:28
      at Generator.throw (<anonymous>)
      at rejected (tests/dispenser.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  6) dispenser — full security test suite
       5. distribute
         FIX #1: wrong recipient token account owner rejected:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:408:28
      at Generator.throw (<anonymous>)
      at rejected (tests/dispenser.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  7) dispenser — full security test suite
       5. distribute
         DRAIN: wrong vault (different authority) rejected:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:427:28
      at Generator.throw (<anonymous>)
      at rejected (tests/dispenser.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  8) dispenser — full security test suite
       5. distribute
         legitimate distribution succeeds:
     Error: AnchorError caused by account: token_program. Error Code: InvalidProgramId. Error Number: 3008. Error Message: Program ID was not as expected.
Program log: Left:
Program log: TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb
Program log: Right:
Program log: TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  9) dispenser — full security test suite
       5. distribute
         DRAIN: double-distribute blocked:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:492:28
      at Generator.throw (<anonymous>)
      at rejected (tests/dispenser.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  10) dispenser — full security test suite
       6. cancel
         GRIEF: cannot cancel already-distributed:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:566:28
      at Generator.next (<anonymous>)
      at fulfilled (tests/dispenser.ts:28:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  11) dispenser — full security test suite
       6. cancel
         GRIEF: cannot distribute after cancel:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:585:28
      at Generator.throw (<anonymous>)
      at rejected (tests/dispenser.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  12) dispenser — full security test suite
       8. state accounting
         total_distributed matches actual transfers:

      AssertionError: expected +0 to equal 10000000000000
      + expected - actual

      -0
      +10000000000000
      
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:623:14
      at Generator.next (<anonymous>)
      at fulfilled (tests/dispenser.ts:28:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)



error Command failed with exit code 12.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
