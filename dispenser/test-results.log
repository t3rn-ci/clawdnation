warning: unexpected `cfg` condition value: `custom-heap`
 --> programs/dispenser/src/lib.rs:7:1
  |
7 | #[program]
  | ^^^^^^^^^^
  |
  = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
  = help: consider adding `custom-heap` as a feature in `Cargo.toml`
  = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
  = note: `#[warn(unexpected_cfgs)]` on by default
  = note: this warning originates in the macro `$crate::custom_heap_default` which comes from the expansion of the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `custom-panic`
 --> programs/dispenser/src/lib.rs:7:1
  |
7 | #[program]
  | ^^^^^^^^^^
  |
  = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
  = help: consider adding `custom-panic` as a feature in `Cargo.toml`
  = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
  = note: this warning originates in the macro `$crate::custom_panic_default` which comes from the expansion of the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
 --> programs/dispenser/src/lib.rs:7:1
  |
7 | #[program]
  | ^^^^^^^^^^
  |
  = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
  = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
  = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
  = note: this warning originates in the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
 --> programs/dispenser/src/lib.rs:7:1
  |
7 | #[program]
  | ^^^^^^^^^^
  |
  = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
  = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
  = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
  = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/dispenser/src/lib.rs:325:10
    |
325 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/dispenser/src/lib.rs:341:10
    |
341 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/dispenser/src/lib.rs:348:10
    |
348 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/dispenser/src/lib.rs:355:10
    |
355 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/dispenser/src/lib.rs:362:10
    |
362 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/dispenser/src/lib.rs:382:10
    |
382 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/dispenser/src/lib.rs:409:10
    |
409 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: use of deprecated method `anchor_lang::prelude::AccountInfo::<'a>::realloc`: Use AccountInfo::resize() instead
 --> programs/dispenser/src/lib.rs:7:1
  |
7 | #[program]
  | ^^^^^^^^^^
  |
  = note: `#[warn(deprecated)]` on by default
  = note: this warning originates in the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: `dispenser` (lib) generated 17 warnings (5 duplicates)
    Finished `release` profile [optimized] target(s) in 0.16s
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.15s
     Running unittests src/lib.rs (/Users/mbultra/projects/clawdnation/dispenser/target/debug/deps/dispenser-b1c572788ea533d1)

Found a 'test' script in the Anchor.toml. Running it as a test suite!

Running test suite: "/Users/mbultra/projects/clawdnation/dispenser/Anchor.toml"

yarn run v1.22.19
warning ../package.json: No license field
$ /Users/mbultra/projects/clawdnation/dispenser/node_modules/.bin/ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/*.ts'
(node:21121) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /Users/mbultra/projects/clawdnation/dispenser/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  dispenser — full security test suite
    1. initialization
      ✔ initializes with correct authority and pending_authority=None (470ms)
      ✔ GRIEF: re-initialization blocked (PDA exists)
    2. operator management
      ✔ authority adds operator (466ms)
      ✔ PRIV-ESC: non-operator cannot add themselves
      ✔ PRIV-ESC: non-operator cannot remove operator
      ✔ PRIV-ESC: cannot remove authority
      ✔ duplicate add is idempotent (460ms)
      1) FIX #3: max 10 operators enforced
    3. authority transfer (2-step)
      2) authority proposes transfer
      ✔ PRIV-ESC: non-authority cannot propose transfer
      3) PRIV-ESC: wrong person cannot accept transfer
      ✔ authority can cancel transfer (446ms)
      ✔ GRIEF: accept with no pending transfer fails
      4) full transfer cycle works
    4. add_recipient
      ✔ operator queues distribution (465ms)
      ✔ FIX #2: zero amount rejected
      ✔ GRIEF: duplicate contribution_id blocked (PDA exists)
      ✔ GRIEF: non-operator cannot queue
      ✔ FIX #4: overflow on total_queued rejected
      ✔ queue second distribution (445ms)
    5. distribute
      ✔ DRAIN: non-operator cannot distribute (474ms)
      ✔ FIX #1: wrong recipient token account owner rejected (464ms)
      ✔ DRAIN: wrong vault (different authority) rejected (474ms)
      ✔ DRAIN: wrong mint rejected (1411ms)
      ✔ legitimate distribution succeeds (598ms)
      ✔ DRAIN: double-distribute blocked
    6. cancel
      ✔ GRIEF: non-operator cannot cancel
      ✔ operator cancels queued distribution (471ms)
      ✔ GRIEF: cannot double-cancel
      ✔ GRIEF: cannot cancel already-distributed
      ✔ GRIEF: cannot distribute after cancel (467ms)
    7. account safety
      ✔ state PDA owned by program
      ✔ distribution PDAs owned by program
      ✔ vault has correct authority (state PDA)
    8. state accounting
      ✔ total_distributed matches actual transfers
    total_queued: 20000000000000
    total_distributed: 10000000000000
    total_cancelled: 5000000000000
      ✔ total_queued tracks pending distributions
      ✔ FIX #4: checked arithmetic on cancel (total_queued subtraction)


  33 passing (16s)
  4 failing

  1) dispenser — full security test suite
       2. operator management
         FIX #3: max 10 operators enforced:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:169:28
      at Generator.next (<anonymous>)
      at fulfilled (tests/dispenser.ts:28:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  2) dispenser — full security test suite
       3. authority transfer (2-step)
         authority proposes transfer:
     Error: AnchorError caused by account: state. Error Code: AccountDidNotSerialize. Error Number: 3004. Error Message: Failed to serialize the account.
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  3) dispenser — full security test suite
       3. authority transfer (2-step)
         PRIV-ESC: wrong person cannot accept transfer:
     AssertionError: expected false to be truthy
      at /Users/mbultra/projects/clawdnation/dispenser/tests/dispenser.ts:208:28
      at Generator.throw (<anonymous>)
      at rejected (tests/dispenser.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  4) dispenser — full security test suite
       3. authority transfer (2-step)
         full transfer cycle works:
     Error: AnchorError caused by account: state. Error Code: AccountDidNotSerialize. Error Number: 3004. Error Message: Failed to serialize the account.
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)



error Command failed with exit code 4.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
